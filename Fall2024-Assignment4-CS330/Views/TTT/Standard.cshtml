@model Fall2024_Assignment4_CS330.Models.TTTModel
@{
    ViewBag.Title = "Tic Tac Toe";
    var playerColor = Model.CurrentPlayer == 'X' ? "text-danger" : "text-info";
    var pointerEvents = Model.Status == Status.Active ? "all" : "none";
    string opp = "";
    if (Model.Mode == "Online")
    {
        char self_x_or_o = (User.FindFirst(System.Security.Claims.ClaimTypes.NameIdentifier)?.Value == Model.Player1Id) ? 'X' : 'O';
        opp = self_x_or_o == 'X' ? Model.Player2Id : Model.Player1Id;
    }
    var time = Model.MaxTime;
}

<script>
    console.log("Player " + "@Model.CurrentPlayer" + "'s turn!");
</script>

<script>
    let maxTime = @time;
    // ensure the video does not fully restart upon refresh
    document.addEventListener("DOMContentLoaded", () => {
        const video = document.getElementById("roku-video");
        const STORAGE_KEY = "videoPlaybackTime";

        if (!video) {
            console.error("Video element not found. Check your HTML for the correct ID.");
            return;
        }

        // Ensure the video is ready before setting currentTime
        video.addEventListener("loadedmetadata", () => {
            const savedTime = localStorage.getItem(STORAGE_KEY);
            if (savedTime) {
                video.currentTime = parseFloat(savedTime);
            }
        });

        // Save playback time every second
        const updatePlaybackTime = () => {
            if (!isNaN(video.currentTime)) {
                localStorage.setItem(STORAGE_KEY, video.currentTime);
            }
        };

        // Save playback time periodically
        const saveInterval = setInterval(updatePlaybackTime, 1000);

        // Cleanup on page unload
        window.addEventListener("beforeunload", () => {
            updatePlaybackTime();
            clearInterval(saveInterval);
        });
    });
</script>

<div class="video-background">
    <video id="roku-video" autoplay loop muted playsinline preload="auto">
        <source src="/lib/roku_60fps_interpolated.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>
</div>

<div class="container d-flex flex-column justify-content-center align-items-center text-center">
    <div class="decorative-background p-4 rounded mb-3">
        <h2 class="text-primary m-0">Tic Tac Toe - @Model.Mode - <span class="@playerColor">@Model.CurrentPlayer</span></h2>
        @if (Model.Status == Status.Queued)
        {   
            var s = "";
            if (Model.Publicity == Publicity.Private) s = "Join Code: " + Model.JoinCode;
            <h4 class="text-secondary">In the queue... @s</h4>
        }
        else if (Model.Status == Status.Active && Model.Mode == "Online")
        {
            <h4 class="text-secondary">Connected to player: @opp</h4>
        }
    </div>
    <div>
        <table class="board" border="1" style="border-collapse: collapse; width: 450px; height: 450px; text-align: center; pointer-events: @pointerEvents;">
            @for (int x = 0; x < 3; x++) // Board rows
            {
                <tr>
                    @for (int y = 0; y < 3; y++) // Board columns
                    {
                        var winner = Model.CheckGridWinner(x, y);
                        var gridClass = "";
                        var cellClass = "";
                        if (winner == 'X') 
                        {
                            gridClass = "claimed-x";
                        } 
                        else if (winner == 'O') 
                        {
                            gridClass = "claimed-o";
                        } 
                        else if (!Model.IsGridPlayable(x, y))
                        {
                            gridClass = "tied-grid";
                        }

                        if (Model.RestrictedGrid == x * 3 + y) cellClass = "restricted-grid";
                    
                        <td style="width: 150px; height: 150px;">
                            <table class="grid @gridClass" border="1" style="border-collapse: collapse; width: 100%; height: 100%; text-align: center;">
                                @for (int z = 0; z < 3; z++) // Grid rows
                                {
                                    <tr>
                                        @for (int w = 0; w < 3; w++) // Grid columns
                                        {
                                            var textColor = "";
                                            if (Model.Board[x, y, z, w] == 'X') textColor = "text-danger";
                                            if (Model.Board[x, y, z, w] == 'O') textColor = "text-info";

                                            <td class="cell" style="width: 50px; height: 50px;">
                                                @if (Model.Board[x,y,z,w] == '\0')
                                                {
                                                    <form method="post" action="@Url.Action("MakeMove", "TTT")" style="display: inline;">
                                                        <input type="hidden" name="gridRow" value="@x" />
                                                        <input type="hidden" name="gridCol" value="@y" />
                                                        <input type="hidden" name="cellRow" value="@z" />
                                                        <input type="hidden" name="cellCol" value="@w" />
                                                        <button class=@cellClass type="submit" style="width: 100%; height: 100%; font-size: 20px;"></button>
                                                    </form>
                                                }
                                                else
                                                {
                                                    <h4 class=@textColor>@Model.Board[x,y,z,w]</h4>
                                                }
                                            </td>
                                        }
                                    </tr>
                                }
                            </table>
                        </td>
                    }
                </tr>
            }
        </table>
    </div>
    @if (Model.Mode != "Online")
    {
        <div class="hintDiv p-3">
            <form method="post" action="@Url.Action("GetHint", "TTT")">
                <button type="submit" id="getHintButton">Get a Hint</button>
            </form>
            <p id="hintText">
                @ViewBag.Hint
            </p>
        </div>
    }
</div>
<div class="decorative-background p-4 rounded mb-3">
    @if (ViewBag.Message != null)
    {
        <h3 class="text-secondary">@ViewBag.Message</h3>
    }
    @if (Model.Mode != "Online")
    {
        <form method="get" action="@Url.Action("Reset", "TTT")">
            <button class="btn btn-primary" type="submit" style="margin-top: 20px;">Restart Game</button>
        </form>
    }
</div>
